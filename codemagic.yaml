definitions:
  environment:
    shared_env: &shared_env
      flutter: 3.22.3
      groups:
        - shorebird
        - firebase_credentials
        - selleri-stage
      vars:
        FLUTTER_VERSION: 3.22.3
  scripts:
    - &create_env
      name: Create .env
      script: |
        touch "$CM_BUILD_DIR/.env"
          cat >> "$CM_BUILD_DIR/.env" <<EOF
          GRANT_TYPE=password
          CLIENT_ID=2
          HOST=https://selleri.co.id/api
          CLIENT_SECRET=7lJC833F5COjxMfFGS9xcLoPFEmKTIXnf6gYClKR
          APP_ID=selleri
          EOF
    - &create_env_stage
      name: Create .env.stage
      script: |
        touch "$CM_BUILD_DIR/.env.stage"
          cat >> "$CM_BUILD_DIR/.env.stage" <<EOF
          GRANT_TYPE=password
          CLIENT_ID=2
          HOST=https://dev.selleri.co.id/api
          CLIENT_SECRET=7lJC833F5COjxMfFGS9xcLoPFEmKTIXnf6gYClKR
          APP_ID=dev-selleri
          EOF
    - &shorebird_install
      name: Install Shorebird
      script: |
        # Install Shorebird
        curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash

        # Add Shorebird to PATH
        echo PATH="$HOME/.shorebird/bin:$PATH" >> $CM_ENV
    - &fetch_dependencies
      name: Fetch Dependencies
      script: |
        flutter pub get
    - &build_runner
      name: Build Runner
      script: |
        dart run build_runner build -d
    - &analyze_and_test
      name: Analyze and Test
      script: |
        flutter analyze

workflows:
  release-android-stage-workflow:
    name: Release Android Stage
    instance_type: mac_mini_m1
    environment:
      <<: *shared_env
      android_signing:
        - selleri_stage_keystore
    scripts:
      - *shorebird_install
      - *create_env
      - *create_env_stage
      - *fetch_dependencies
      - *build_runner
      - *analyze_and_test
      - name: Shorebird Release
        script: |
          shorebird release android \
            --flavor=stage --flutter-version="$FLUTTER_VERSION" --artifact apk
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      firebase:
        firebase_service_account: $FIREBASE_SERVICE_ACCOUNT
        android:
          app_id: 1:957311922583:android:d61a59e4b45bfdd62794d2
          groups:
            - dgti
          artifact_type: 'apk'

  release-ios-stage-workflow:
    name: Release iOS Stage
    instance_type: mac_mini_m1
    environment:
      <<: *shared_env
      ios_signing:
        certificates:
          - CODEMAGIC_DISTRIBUTION
        bundle_identifier: com.dgti.selleri.stage
    scripts:
      - *shorebird_install
      - *create_env
      - *create_env_stage
      - *fetch_dependencies
      - *build_runner
      - *analyze_and_test
      - name: Shorebird Release
        script: |
          shorebird release ios \
            --flavor=stage --flutter-version="$FLUTTER_VERSION"
    artifacts:
      - build/**/outputs/**/*.apk
      - build/**/outputs/**/mapping.txt
      - flutter_drive.log
    publishing:
      firebase:
        firebase_service_account: $FIREBASE_SERVICE_ACCOUNT
        ios:
          app_id: 1:957311922583:ios:487efa18122c20842794d2
          groups:
            - dgti

  patch-stage-workflow:
    name: Patch Stage Update
    instance_type: mac_mini_m1
    environment:
      <<: *shared_env
      android_signing:
        - selleri_stage_keystore
      ios_signing:
        certificates:
          - CODEMAGIC_DISTRIBUTION
        bundle_identifier: com.dgti.selleri.stage
    inputs:
      release_version:
        description: The stage version to patch
    scripts:
      - *shorebird_install
      - *create_env
      - *create_env_stage
      - *fetch_dependencies
      - *build_runner
      - *analyze_and_test
      - name: Shorebird Patch
        script: |
          shorebird patch android \
            --flavor=stage --release-version=${{ inputs.release_version }}
